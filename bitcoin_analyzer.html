<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pattern Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .controls-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: end;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .results-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .results-title {
            font-size: 1.5em;
            color: #333;
            font-weight: 600;
        }

        .pattern-count {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 500px;
            margin-bottom: 30px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .patterns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .pattern-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: transform 0.3s ease;
        }

        .pattern-card:hover {
            transform: translateY(-2px);
        }

        .pattern-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .pattern-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .pattern-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-completed { background: #d4edda; color: #155724; }
        .status-failed { background: #f8d7da; color: #721c24; }
        .status-in-progress { background: #fff3cd; color: #856404; }
        .status-progressive { background: #cce5ff; color: #004085; }

        .pattern-details {
            margin-top: 10px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-label {
            font-weight: 600;
            color: #666;
        }

        .detail-value {
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .info-panel {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e0e8f0;
        }

        .info-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .backend-status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .backend-connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .backend-simulation {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }

            .patterns-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Pattern Analyzer</h1>
            <p>A-B-C-D Pattern Detection</p>
        </div>

        <div class="controls-panel">
            <div id="backendStatus" class="backend-status" style="display: none;"></div>

            <div class="form-row">
                <div class="form-group">
                    <label for="dateInput">Analysis Date</label>
                    <input type="date" id="dateInput" required>
                </div>
                <div class="form-group">
                    <label for="timeInput">Specific Time (Optional)</label>
                    <input type="time" id="timeInput">
                </div>
                <div class="form-group">
                    <label for="timeWindow">Time Window (Minutes)</label>
                    <input type="number" id="timeWindow" value="30" min="5" max="120">
                </div>
                <div class="form-group">
                    <label for="minChange">Min Change (%)</label>
                    <input type="number" id="minChange" value="0.3" min="0.1" max="5" step="0.1">
                </div>
                <div class="form-group">
                    <button class="btn" onclick="analyzeData()" id="analyzeBtn">
                        üîç Analyze Patterns
                    </button>
                </div>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <div class="results-title">Analysis Results</div>
                <div class="pattern-count" id="patternCount">0 Patterns Found</div>
            </div>

            <div class="info-panel" id="infoPanel" style="display: none;">
                <div class="info-title">Market Overview</div>
                <div id="marketInfo"></div>
            </div>

            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>

            <div class="patterns-grid" id="patternsGrid">
            </div>
        </div>
    </div>

    <script>
        console.log('JavaScript loading...');

        let priceChart = null;
        let currentData = null;
        let backendConnected = false;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');

            // Set default date
            document.getElementById('dateInput').valueAsDate = new Date();

            // Check backend status
            checkBackendStatus();
        });

        function analyzeData() {
            console.log('analyzeData() called');

            const dateInput = document.getElementById('dateInput').value;
            const timeInput = document.getElementById('timeInput').value;
            const timeWindow = parseInt(document.getElementById('timeWindow').value);
            const minChange = parseFloat(document.getElementById('minChange').value) / 100;

            console.log('Form values:', {dateInput, timeInput, timeWindow, minChange});

            if (!dateInput) {
                alert('Please select a date');
                return;
            }

            const analyzeBtn = document.getElementById('analyzeBtn');
            const resultsSection = document.getElementById('resultsSection');

            // Show loading state
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = 'Analyzing...';
            resultsSection.style.display = 'block';

            // Call analysis function
            performAnalysis(dateInput, timeInput, timeWindow, minChange)
                .then(function(data) {
                    console.log('Analysis complete:', data);
                    displayResults(data);
                })
                .catch(function(error) {
                    console.error('Analysis failed:', error);
                    showError('Analysis failed: ' + error.message);
                })
                .finally(function() {
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = 'üîç Analyze Patterns';
                });
        }

        async function checkBackendStatus() {
            console.log('Checking backend status...');

            try {
                const response = await fetch('/api/parameters');
                if (response.ok) {
                    const params = await response.json();
                    console.log('Backend parameters:', params);

                    backendConnected = true;
                    showBackendStatus('connected', 'Backend Connected - Min Change: ' + params.min_change + ', Windows: [' + params.window_sizes.join(', ') + ']');
                    document.getElementById('minChange').value = (params.min_change * 100).toFixed(1);
                } else {
                    console.log('Backend not responding');
                    showBackendStatus('simulation', 'Backend not available - Using simulation');
                }
            } catch (error) {
                console.log('Backend connection failed:', error);
                showBackendStatus('simulation', 'Backend not available - Using simulation');
            }
        }

        function showBackendStatus(type, message) {
            const statusDiv = document.getElementById('backendStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = 'backend-status backend-' + type;
            statusDiv.textContent = message;
        }

        async function performAnalysis(date, time, timeWindow, minChange) {
            console.log('Performing analysis for:', {date, time, timeWindow, minChange});

            // Try backend first
            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        date: date,
                        time: time,
                        timeWindow: timeWindow,
                        minChange: minChange
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Backend response:', data);
                    showBackendStatus('connected', 'Backend Connected - Using real data');

                    return {
                        prices: data.prices,
                        timestamps: data.timestamps.map(ts => new Date(ts)),
                        patterns: data.patterns,
                        originalDate: data.date,
                        originalTime: data.time,
                        isRealData: true
                    };
                } else {
                    const errorData = await response.json();
                    console.log('Backend error:', errorData);
                    showBackendStatus('simulation', 'Backend error: ' + errorData.error);
                }
            } catch (error) {
                console.log('Backend request failed:', error);
                showBackendStatus('simulation', 'Backend not available');
            }

            // Fallback to simulation
            console.log('Using simulation data');
            return generateSimulationData(date, time, timeWindow, minChange);
        }

        function generateSimulationData(date, time, timeWindow, minChange) {
            console.log('Generating simulation data');

            const basePrice = 67000 + Math.random() * 4000;
            const dataPoints = time ? timeWindow * 2 : 1440;
            const prices = [];
            const timestamps = [];

            let currentPrice = basePrice;
            const startDate = new Date(date + 'T00:00:00');

            for (let i = 0; i < dataPoints; i++) {
                const timestamp = new Date(startDate.getTime() + i * 60000);
                const change = (Math.random() - 0.5) * 0.004; // ¬±0.2% per minute
                currentPrice = currentPrice * (1 + change);

                prices.push(currentPrice);
                timestamps.push(timestamp);
            }

            // Generate simple patterns
            const patterns = [];
            if (prices.length > 100) {
                const quarter = Math.floor(prices.length / 4);

                patterns.push({
                    direction: 'up',
                    status: 'completed',
                    A: [quarter, prices[quarter]],
                    B: [quarter * 2, prices[quarter * 2]],
                    C: [quarter * 3, prices[quarter * 3]],
                    D: [quarter * 4 - 1, prices[quarter * 4 - 1]],
                    initial_move_pct: Math.abs((prices[quarter * 2] - prices[quarter]) / prices[quarter] * 100),
                    retracement_pct: Math.abs((prices[quarter * 3] - prices[quarter * 2]) / (prices[quarter * 2] - prices[quarter]) * 100)
                });
            }

            return {
                prices: prices,
                timestamps: timestamps,
                patterns: patterns,
                originalDate: date,
                originalTime: time,
                isRealData: false
            };
        }

        function displayResults(data) {
            console.log('Displaying results:', data);

            currentData = data;

            document.getElementById('patternCount').textContent = data.patterns.length + ' Patterns Found';

            const infoPanel = document.getElementById('infoPanel');
            const marketInfo = document.getElementById('marketInfo');
            infoPanel.style.display = 'block';

            const minPrice = Math.min(...data.prices);
            const maxPrice = Math.max(...data.prices);
            const priceRange = ((maxPrice - minPrice) / minPrice * 100).toFixed(2);

            marketInfo.innerHTML =
                '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">' +
                '<div><strong>Date:</strong> ' + data.originalDate + '</div>' +
                '<div><strong>Time:</strong> ' + (data.originalTime || 'Full Day') + '</div>' +
                '<div><strong>Price Range:</strong> ' + priceRange + '%</div>' +
                '<div><strong>Data Points:</strong> ' + data.prices.length + '</div>' +
                '<div><strong>Source:</strong> ' + (data.isRealData ? 'Real Data' : 'Simulation') + '</div>' +
                '</div>';

            createPriceChart(data);
            displayPatternCards(data.patterns);
        }

        function createPriceChart(data) {
            console.log('Creating chart with', data.prices.length, 'data points');

            const ctx = document.getElementById('priceChart').getContext('2d');

            if (priceChart) {
                priceChart.destroy();
            }

            const labels = data.timestamps.map(ts => ts.toLocaleTimeString('en-US', {hour12: false}));

            const datasets = [{
                label: 'Bitcoin Price',
                data: data.prices,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.1
            }];

            // Add pattern points
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1'];
            const pointColors = ['#000000', '#ff0000', '#00ff00', '#0000ff'];

            data.patterns.forEach(function(pattern, idx) {
                const patternColor = colors[idx % colors.length];

                // Add pattern line
                const patternPoints = [];
                ['A', 'B', 'C', 'D'].forEach(function(point) {
                    if (pattern[point]) {
                        const index = pattern[point][0];
                        const price = pattern[point][1];
                        patternPoints.push({x: labels[index], y: price});
                    }
                });

                datasets.push({
                    label: pattern.direction.toUpperCase() + ' Pattern ' + (idx + 1),
                    data: patternPoints,
                    borderColor: patternColor,
                    backgroundColor: 'transparent',
                    pointRadius: 0,
                    showLine: true,
                    borderWidth: 2,
                    fill: false,
                    tension: 0
                });

                // Add individual points
                ['A', 'B', 'C', 'D'].forEach(function(point, pointIdx) {
                    if (pattern[point]) {
                        const index = pattern[point][0];
                        const price = pattern[point][1];
                        const pointColor = pointColors[pointIdx];

                        datasets.push({
                            label: 'Point ' + point + (idx + 1),
                            data: [{x: labels[index], y: price}],
                            borderColor: pointColor,
                            backgroundColor: pointColor,
                            pointRadius: 10,
                            showLine: false,
                            borderWidth: 2
                        });
                    }
                });
            });

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Bitcoin Analysis - ' + data.originalDate + ' (' + (data.isRealData ? 'Real Data' : 'Simulation') + ')',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Time' }
                        },
                        y: {
                            title: { display: true, text: 'Price (USD)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function displayPatternCards(patterns) {
            const grid = document.getElementById('patternsGrid');
            grid.innerHTML = '';

            patterns.forEach(function(pattern, idx) {
                const card = createPatternCard(pattern, idx + 1);
                grid.appendChild(card);
            });
        }

        function createPatternCard(pattern, index) {
            const card = document.createElement('div');
            card.className = 'pattern-card';

            const statusClass = 'status-' + pattern.status.replace('_', '-');

            card.innerHTML =
                '<div class="pattern-header">' +
                '<div class="pattern-title">Pattern ' + index + ': ' + pattern.direction.toUpperCase() + 'TREND</div>' +
                '<div class="pattern-status ' + statusClass + '">' + pattern.status + '</div>' +
                '</div>' +
                '<div class="pattern-details">' +
                '<div class="detail-row">' +
                '<span class="detail-label">Initial Move:</span>' +
                '<span class="detail-value">' + pattern.initial_move_pct.toFixed(2) + '%</span>' +
                '</div>' +
                '<div class="detail-row">' +
                '<span class="detail-label">Retracement:</span>' +
                '<span class="detail-value">' + pattern.retracement_pct.toFixed(1) + '%</span>' +
                '</div>' +
                '<div class="detail-row">' +
                '<span class="detail-label">A Point:</span>' +
                '<span class="detail-value">$' + pattern.A[1].toFixed(2) + '</span>' +
                '</div>' +
                '<div class="detail-row">' +
                '<span class="detail-label">B Point:</span>' +
                '<span class="detail-value">$' + pattern.B[1].toFixed(2) + '</span>' +
                '</div>' +
                '<div class="detail-row">' +
                '<span class="detail-label">C Point:</span>' +
                '<span class="detail-value">$' + pattern.C[1].toFixed(2) + '</span>' +
                '</div>' +
                '<div class="detail-row">' +
                '<span class="detail-label">D Point:</span>' +
                '<span class="detail-value">$' + pattern.D[1].toFixed(2) + '</span>' +
                '</div>' +
                '</div>';

            return card;
        }

        function showError(message) {
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.innerHTML = '<div class="error-message">' + message + '</div>';
            resultsSection.style.display = 'block';
        }

        console.log('JavaScript loaded successfully');
    </script>
</body>
</html>